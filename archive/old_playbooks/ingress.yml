---
- name: Configure Ingress
  hosts: k8s_cluster
  gather_facts: false
  vars:
    version: 4.13.2  # https://github.com/kubernetes/ingress-nginx?tab=readme-ov-file#supported-versions-table
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  tasks:
    - name: Create namespace for nginx ingress
      kubernetes.core.k8s:
        kind: Namespace
        name: ingress-nginx
        state: present
        kubeconfig: "{{ kubeconfig_path }}"

    - name: Add helm repo for nginx ingress
      kubernetes.core.helm_repository:
        name: ingress-nginx
        state: present
        repo_url: https://kubernetes.github.io/ingress-nginx

    - name: Helm install nginx ingress controller
      kubernetes.core.helm:
        name: ingress-nginx
        namespace: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        chart_version: "{{ version }}"
        kubeconfig: "{{ kubeconfig_path }}"
        values:
          controller:
            hostNetwork: true
            hostPort:
              enabled: true
            ingressClassResource:
              default: true
            kind: "DaemonSet"
            service:
              type: "ClusterIP"
            watchIngressWithoutClass: true
            config:
              proxy-body-size: "100G"
    - name: "Fix for issue https://github.com/kubernetes/ingress-nginx/issues/5401"
      kubernetes.core.k8s:
        name: ingress-nginx-admission
        kind: ValidatingWebhookConfiguration
        state: absent
        kubeconfig: "{{ kubeconfig_path }}"
